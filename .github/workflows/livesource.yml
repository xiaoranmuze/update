name: ğŸ“¡ Live Source Processing

# Channel Aggregator & Processor

on:
  push:
    branches: [ main1, master ]
  schedule:
    # æ¯å¤©è¿è¡Œä¸¤æ¬¡ï¼ˆUTCæ—¶é—´ å¯¹åº”åŒ—äº¬æ—¶é—´ 6:00 å’Œ 18:00ï¼‰
    - cron: '0 10,22 * * *'
  workflow_dispatch:

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install opencc-python-reimplemented

    - name: Run live source generator
      run: |
        python assets/livesource/livesource.py
      env:
        PYTHONUNBUFFERED: 1
        # è®¾ç½®è¶…æ—¶é¿å…ç½‘ç»œè¯·æ±‚å¡ä½
        REQUEST_TIMEOUT: 30

    - name: Check generated files
      run: |
        echo "ğŸ“ ç”Ÿæˆçš„ç›´æ’­æºæ–‡ä»¶:"
        ls -la output/
        echo ""
        echo "ğŸ“Š æ–‡ä»¶è¯¦æƒ…:"
        for file in output/*.txt output/*.m3u; do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            size=$(du -h "$file" | cut -f1)
            echo "  ğŸ“„ $file: $lines è¡Œ, $size"
          fi
        done

    - name: Configure Git
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

    - name: Check for changes
      id: check-changes
      run: |
        git add output/
        if git diff --staged --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "ğŸ“­ æ²¡æœ‰æ£€æµ‹åˆ°æ–°çš„ç›´æ’­æºå˜åŒ–"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“¬ æ£€æµ‹åˆ°ç›´æ’­æºæ›´æ–°ï¼Œå‡†å¤‡æäº¤"
          
          # æ˜¾ç¤ºå…·ä½“å˜åŒ–
          echo "ğŸ”„ æ–‡ä»¶å˜åŒ–è¯¦æƒ…:"
          git diff --staged --name-only
        fi

    - name: Commit and push changes
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        git add output/
        git commit -m "ğŸ¤– $(TZ='Asia/Shanghai' date +%Y-%m-%d\ %H:%M:%S)"
        
        # é‡è¯•æœºåˆ¶
        for i in 1 2 3; do
          echo "ğŸ”„ å°è¯•æ¨é€ ($i/3)..."
          if git push; then
            echo "âœ… æ¨é€æˆåŠŸ"
            break
          else
            echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œç­‰å¾…é‡è¯•..."
            sleep 10
            git pull --rebase
          fi
        done

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: live-sources
        path: output/
        retention-days: 5

    - name: Success notification
      if: success()
      run: |
        echo "ğŸ‰ ç›´æ’­æºç”Ÿæˆå’Œéƒ¨ç½²å®Œæˆï¼"
        echo "â° æ›´æ–°æ—¶é—´: $(TZ='Asia/Shanghai' date +%Y-%m-%d\ %H:%M:%S)"
        echo "ğŸ“ è¾“å‡ºæ–‡ä»¶å·²ä¿å­˜è‡³: output/"
        if [ "${{ steps.check-changes.outputs.changes }}" == "true" ]; then
          echo "ğŸ”„ å·²è‡ªåŠ¨æäº¤æ›´æ”¹åˆ°ä»“åº“"
        else
          echo "ğŸ“­ æ— æ–°å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        fi
