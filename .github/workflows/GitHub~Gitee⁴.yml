name: 'ğŸš€ GitHub â†” Gitee coreâ´'

on:
  workflow_dispatch:
    inputs:
      sync_mode:
        description: 'åŒæ­¥æ¨¡å¼'
        required: true
        type: choice
        options:
          - 'å¢é‡'
          - 'è¦†ç›–'
        default: 'å¢é‡'
      
      source_folder:
        description: 'GitHubæºæ–‡ä»¶å¤¹è·¯å¾„ï¼ˆç•™ç©º=æ ¹ç›®å½•ï¼‰'
        required: false
        default: ''
        type: string
      
      target_folder:
        description: 'Giteeç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆç•™ç©º=æ ¹ç›®å½•ï¼‰'
        required: false
        default: ''
        type: string
      
      commit_message:
        description: 'æäº¤ä¿¡æ¯ï¼ˆå¯ç”¨å˜é‡ï¼š{time} {date}ï¼‰'
        required: false
        default: 'ğŸ”„ ä»GitHubåŒæ­¥ {date} {time}'
        type: string

env:
  # æºä»“åº“ï¼ˆGitHubï¼‰
  GITHUB_USER: 'xiaoran67'
  GITHUB_REPO: 'core'
  GITHUB_BRANCH: 'main'
  GITHUB_TOKEN_SECRET: 'XIAORAN67_GITHUB_TOKEN'
  
  # ç›®æ ‡ä»“åº“ï¼ˆGiteeï¼‰
  GITEE_USER: 'xiaoran67'
  GITEE_REPO: 'core'
  GITEE_BRANCH: 'master'
  GITEE_TOKEN_SECRET: 'XIAORAN67_GITEE_TOKEN'

jobs:
  github-to-gitee-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # 1. æ˜¾ç¤ºåŒæ­¥ä¿¡æ¯
      - name: ğŸ“‹ æ˜¾ç¤ºåŒæ­¥é…ç½®
        run: |
          echo "========================================"
          echo "ğŸš€ GitHub â†’ Gitee åŒæ­¥é…ç½®"
          echo "========================================"
          echo "ğŸ“¥ æºä»“åº“ (GitHub):"
          echo "   ç”¨æˆ·: ${{ env.GITHUB_USER }}"
          echo "   ä»“åº“: ${{ env.GITHUB_REPO }}"
          echo "   åˆ†æ”¯: ${{ env.GITHUB_BRANCH }}"
          echo "   Token: ${{ env.GITHUB_TOKEN_SECRET }}"
          echo ""
          echo "ğŸ“¤ ç›®æ ‡ä»“åº“ (Gitee):"
          echo "   ç”¨æˆ·: ${{ env.GITEE_USER }}"
          echo "   ä»“åº“: ${{ env.GITEE_REPO }}"
          echo "   åˆ†æ”¯: ${{ env.GITEE_BRANCH }}"
          echo "   Token: ${{ env.GITEE_TOKEN_SECRET }}"
          echo ""
          echo "âš™ï¸ åŒæ­¥è®¾ç½®:"
          echo "   æ¨¡å¼: ${{ github.event.inputs.sync_mode }}"
          echo "   æºæ–‡ä»¶å¤¹: ${{ github.event.inputs.source_folder || 'æ ¹ç›®å½•' }}"
          echo "   ç›®æ ‡æ–‡ä»¶å¤¹: ${{ github.event.inputs.target_folder || 'æ ¹ç›®å½•' }}"
          echo "========================================"

      # 2. æ ¡éªŒToken
      - name: ğŸ”‘ æ ¡éªŒToken
        run: |
          echo "=== æ ¡éªŒToken ==="
          
          # æ£€æŸ¥GitHub Token
          if [ -z "${{ secrets[env.GITHUB_TOKEN_SECRET] }}" ]; then
            echo "âŒ GitHub Tokenä¸å­˜åœ¨: ${{ env.GITHUB_TOKEN_SECRET }}"
            echo "è¯·åœ¨GitHubä»“åº“çš„Settings â†’ Secrets â†’ Actionsä¸­æ·»åŠ :"
            echo "åç§°: ${{ env.GITHUB_TOKEN_SECRET }}"
            echo "å€¼: GitHubä¸ªäººè®¿é—®ä»¤ç‰Œï¼ˆéœ€è¦æœ‰repoæƒé™ï¼‰"
            exit 1
          fi
          
          # æ£€æŸ¥Gitee Token
          if [ -z "${{ secrets[env.GITEE_TOKEN_SECRET] }}" ]; then
            echo "âŒ Gitee Tokenä¸å­˜åœ¨: ${{ env.GITEE_TOKEN_SECRET }}"
            echo "è¯·åœ¨GitHubä»“åº“çš„Settings â†’ Secrets â†’ Actionsä¸­æ·»åŠ :"
            echo "åç§°: ${{ env.GITEE_TOKEN_SECRET }}"
            echo "å€¼: Giteeç§äººä»¤ç‰Œï¼ˆè®¿é—®: https://gitee.com/profile/personal_access_tokensï¼‰"
            exit 1
          fi
          
          echo "âœ… Tokenæ ¡éªŒé€šè¿‡"

      # 3. å®‰è£…å¿…è¦å·¥å…·
      - name: ğŸ› ï¸ å®‰è£…å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync git curl tree

      # 4. ä»GitHubæ£€å‡ºæºä»“åº“
      - name: ğŸ“¥ ä»GitHubæ£€å‡ºæºä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITHUB_USER }}/${{ env.GITHUB_REPO }}
          ref: ${{ env.GITHUB_BRANCH }}
          path: github_repo
          token: ${{ secrets[env.GITHUB_TOKEN_SECRET] }}
          fetch-depth: 1
          clean: true

      # 5. æ˜¾ç¤ºæºä»“åº“å†…å®¹
      - name: ğŸ“ æŸ¥çœ‹æºä»“åº“å†…å®¹
        run: |
          echo "=== GitHubæºä»“åº“å†…å®¹ ==="
          echo "è·¯å¾„: $(pwd)/github_repo"
          echo "æ–‡ä»¶æ•°: $(find github_repo -type f | wc -l)ä¸ªæ–‡ä»¶"
          echo "å¤§å°: $(du -sh github_repo | cut -f1)"
          echo ""
          echo "ç›®å½•ç»“æ„:"
          tree -L 2 github_repo || ls -la github_repo/

      # 6. ä»Giteeå…‹éš†ç›®æ ‡ä»“åº“
      - name: ğŸ“¥ å…‹éš†Giteeç›®æ ‡ä»“åº“
        run: |
          echo "=== å…‹éš†Giteeç›®æ ‡ä»“åº“ ==="
          GITEE_TOKEN="${{ secrets[env.GITEE_TOKEN_SECRET] }}"
          
          # Giteeçš„URLæ ¼å¼ï¼šhttps://ç”¨æˆ·å:token@gitee.com/ç”¨æˆ·å/ä»“åº“å.git
          GITEE_URL="https://${{ env.GITEE_USER }}:$GITEE_TOKEN@gitee.com/${{ env.GITEE_USER }}/${{ env.GITEE_REPO }}.git"
          echo "Gitee URL: https://${{ env.GITEE_USER }}:****@gitee.com/${{ env.GITEE_USER }}/${{ env.GITEE_REPO }}.git"
          
          # å°è¯•å…‹éš†ç›®æ ‡ä»“åº“
          set +e
          echo "æ­£åœ¨å…‹éš†Giteeä»“åº“..."
          git clone --branch ${{ env.GITEE_BRANCH }} --depth=1 "$GITEE_URL" gitee_repo 2>&1 | tee clone.log
          CLONE_STATUS=$?
          set -e
          
          if [ $CLONE_STATUS -eq 0 ]; then
            echo "âœ… Giteeä»“åº“å…‹éš†æˆåŠŸ"
          else
            echo "âš ï¸ Giteeä»“åº“å…‹éš†å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯:"
            cat clone.log
            echo ""
            echo "å°è¯•åˆå§‹åŒ–ç©ºä»“åº“..."
            rm -rf gitee_repo
            mkdir -p gitee_repo
            cd gitee_repo
            git init
            git remote add origin "$GITEE_URL"
            git checkout -b ${{ env.GITEE_BRANCH }} || git checkout -b main
            cd ..
            echo "âœ… å·²åˆå§‹åŒ–ç©ºä»“åº“"
          fi
          
          # ç¡®ä¿ç›®æ ‡æ–‡ä»¶å¤¹å­˜åœ¨
          if [ -n "${{ github.event.inputs.target_folder }}" ]; then
            TARGET_FOLDER=$(echo "${{ github.event.inputs.target_folder }}" | sed 's|^/||' | sed 's|/$||')
            mkdir -p "gitee_repo/$TARGET_FOLDER"
            echo "åˆ›å»ºç›®æ ‡æ–‡ä»¶å¤¹: gitee_repo/$TARGET_FOLDER"
          fi

      # 7. æ‰§è¡Œæ–‡ä»¶åŒæ­¥
      - name: ğŸ”„ æ‰§è¡Œæ–‡ä»¶åŒæ­¥
        run: |
          echo "=== æ‰§è¡Œæ–‡ä»¶åŒæ­¥ ==="
          
          # æ„å»ºæºè·¯å¾„å’Œç›®æ ‡è·¯å¾„
          SOURCE_PATH="github_repo"
          TARGET_PATH="gitee_repo"
          
          # å¤„ç†æºæ–‡ä»¶å¤¹
          if [ -n "${{ github.event.inputs.source_folder }}" ]; then
            SOURCE_FOLDER=$(echo "${{ github.event.inputs.source_folder }}" | sed 's|^/||' | sed 's|/$||')
            SOURCE_PATH="github_repo/$SOURCE_FOLDER"
          fi
          
          # å¤„ç†ç›®æ ‡æ–‡ä»¶å¤¹
          if [ -n "${{ github.event.inputs.target_folder }}" ]; then
            TARGET_FOLDER=$(echo "${{ github.event.inputs.target_folder }}" | sed 's|^/||' | sed 's|/$||')
            TARGET_PATH="gitee_repo/$TARGET_FOLDER"
          fi
          
          echo "æºè·¯å¾„: $SOURCE_PATH"
          echo "ç›®æ ‡è·¯å¾„: $TARGET_PATH"
          
          # æ£€æŸ¥æºè·¯å¾„æ˜¯å¦å­˜åœ¨
          if [ ! -e "$SOURCE_PATH" ]; then
            echo "âŒ æºè·¯å¾„ä¸å­˜åœ¨: $SOURCE_PATH"
            echo "GitHubä»“åº“å†…å®¹:"
            find github_repo -type f | head -20
            exit 1
          fi
          
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          mkdir -p "$TARGET_PATH"
          
          # è®¾ç½®æ—¶åŒº
          export TZ='Asia/Shanghai'
          
          # æ˜¾ç¤ºåŒæ­¥å‰ç»Ÿè®¡
          echo "åŒæ­¥å‰ç»Ÿè®¡:"
          echo "- æºç›®å½•æ–‡ä»¶æ•°: $(find "$SOURCE_PATH" -type f | wc -l)"
          echo "- ç›®æ ‡ç›®å½•æ–‡ä»¶æ•°: $(find "$TARGET_PATH" -type f | wc -l)"
          
          # æ‰§è¡ŒåŒæ­¥
          if [ "${{ github.event.inputs.sync_mode }}" = "å¢é‡" ]; then
            echo "ğŸ”„ å¢é‡åŒæ­¥æ¨¡å¼ï¼ˆä¿ç•™ç›®æ ‡ä»“åº“çš„é¢å¤–æ–‡ä»¶ï¼‰"
            rsync -av --times --exclude=".git/" "$SOURCE_PATH/" "$TARGET_PATH/"
          else
            echo "ğŸ”„ è¦†ç›–åŒæ­¥æ¨¡å¼ï¼ˆä½¿Giteeä¸GitHubå®Œå…¨ä¸€è‡´ï¼‰"
            rsync -av --delete --force --times --exclude=".git/" "$SOURCE_PATH/" "$TARGET_PATH/"
          fi
          
          echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆ"
          
          # æ˜¾ç¤ºåŒæ­¥åç»Ÿè®¡
          echo "åŒæ­¥åç»Ÿè®¡:"
          echo "- ç›®æ ‡ç›®å½•æ–‡ä»¶æ•°: $(find "$TARGET_PATH" -type f | wc -l)"
          echo "- ç›®æ ‡ç›®å½•å¤§å°: $(du -sh "$TARGET_PATH" | cut -f1)"

      # 8. æ£€æŸ¥æ–‡ä»¶å˜åŒ–
      - name: ğŸ” æ£€æŸ¥Giteeä»“åº“å˜åŒ–
        id: check_changes
        run: |
          echo "=== æ£€æŸ¥æ–‡ä»¶å˜åŒ– ==="
          cd gitee_repo
          
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # æ£€æŸ¥gitçŠ¶æ€
          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ”„ æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œéœ€è¦æäº¤"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºå˜åŒ–è¯¦æƒ…
            echo "=== å˜åŒ–è¯¦æƒ… ==="
            git status -s
            echo "å˜åŒ–æ–‡ä»¶æ•°: $(git status -s | wc -l)"
          else
            echo "âœ… æ— æ–‡ä»¶å˜åŒ–ï¼Œæ— éœ€æäº¤"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

      # 9. æäº¤å¹¶æ¨é€åˆ°Gitee
      - name: ğŸ“¤ æäº¤åˆ°Gitee
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          echo "=== æäº¤åˆ°Gitee ==="
          cd gitee_repo
          
          # å†æ¬¡ç¡®è®¤Gité…ç½®
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          CURRENT_TIME=$(TZ='Asia/Shanghai' date +'%H:%M:%S')
          CURRENT_DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
          COMMIT_MSG="${{ github.event.inputs.commit_message }}"
          
          # æ›¿æ¢æ¨¡æ¿å˜é‡
          COMMIT_MSG="${COMMIT_MSG//\{time\}/$CURRENT_TIME}"
          COMMIT_MSG="${COMMIT_MSG//\{date\}/$CURRENT_DATE}"
          
          echo "æäº¤ä¿¡æ¯: $COMMIT_MSG"
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶å¹¶æäº¤
          git add -A
          git commit -m "$COMMIT_MSG"
          
          # æ˜¾ç¤ºæäº¤ä¿¡æ¯
          echo "âœ… æäº¤å®Œæˆ"
          echo "æäº¤å“ˆå¸Œ: $(git log -1 --format='%H')"
          echo "æäº¤ä¿¡æ¯: $(git log -1 --format='%s')"

      # 10. æ¨é€åˆ°Gitee
      - name: ğŸš€ æ¨é€åˆ°Gitee
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          echo "=== æ¨é€åˆ°Gitee ==="
          cd gitee_repo
          
          GITEE_TOKEN="${{ secrets[env.GITEE_TOKEN_SECRET] }}"
          GITEE_URL="https://${{ env.GITEE_USER }}:$GITEE_TOKEN@gitee.com/${{ env.GITEE_USER }}/${{ env.GITEE_REPO }}.git"
          
          echo "æ¨é€URL: https://${{ env.GITEE_USER }}:****@gitee.com/${{ env.GITEE_USER }}/${{ env.GITEE_REPO }}.git"
          
          # æ ¹æ®åŒæ­¥æ¨¡å¼å†³å®šæ˜¯å¦å¼ºåˆ¶æ¨é€
          if [ "${{ github.event.inputs.sync_mode }}" = "è¦†ç›–" ]; then
            echo "ğŸ”„ è¦†ç›–æ¨¡å¼ï¼Œä½¿ç”¨å¼ºåˆ¶æ¨é€"
            git push "$GITEE_URL" HEAD:${{ env.GITEE_BRANCH }} --force
          else
            echo "ğŸ”„ å¢é‡æ¨¡å¼ï¼Œä½¿ç”¨æ™®é€šæ¨é€"
            git push "$GITEE_URL" HEAD:${{ env.GITEE_BRANCH }}
          fi
          
          echo "âœ… æ¨é€å®Œæˆ"

      # 11. ç”ŸæˆåŒæ­¥æŠ¥å‘Š
      - name: ğŸ“Š ç”ŸæˆåŒæ­¥æŠ¥å‘Š
        run: |
          echo "========================================"
          echo "ğŸ“Š GitHub â†’ Gitee åŒæ­¥æŠ¥å‘Š"
          echo "========================================"
          
          if [ "${{ steps.check_changes.outputs.changes_detected }}" = "true" ]; then
            echo "âœ… åŒæ­¥å®Œæˆ - å·²æäº¤å¹¶æ¨é€"
            cd gitee_repo
            COMMIT_HASH=$(git log -1 --format='%H' 2>/dev/null || echo 'æ— æäº¤')
            COMMIT_MSG=$(git log -1 --format='%s' 2>/dev/null || echo 'æ— æäº¤')
            echo "ğŸ“ æäº¤å“ˆå¸Œ: $COMMIT_HASH"
            echo "ğŸ“ æäº¤ä¿¡æ¯: $COMMIT_MSG"
          else
            echo "â„¹ï¸ åŒæ­¥å®Œæˆ - æ— æ–‡ä»¶å˜åŒ–"
          fi
          
          echo ""
          echo "ğŸ“¥ æºä»“åº“ (GitHub):"
          echo "   ä»“åº“: ${{ env.GITHUB_USER }}/${{ env.GITHUB_REPO }}"
          echo "   åˆ†æ”¯: ${{ env.GITHUB_BRANCH }}"
          echo "   æ–‡ä»¶å¤¹: ${{ github.event.inputs.source_folder || 'æ ¹ç›®å½•' }}"
          
          echo ""
          echo "ğŸ“¤ ç›®æ ‡ä»“åº“ (Gitee):"
          echo "   ä»“åº“: ${{ env.GITEE_USER }}/${{ env.GITEE_REPO }}"
          echo "   åˆ†æ”¯: ${{ env.GITEE_BRANCH }}"
          echo "   æ–‡ä»¶å¤¹: ${{ github.event.inputs.target_folder || 'æ ¹ç›®å½•' }}"
          
          echo ""
          echo "âš™ï¸ åŒæ­¥é…ç½®:"
          echo "   æ¨¡å¼: ${{ github.event.inputs.sync_mode }}"
          
          echo ""
          echo "ğŸ“ˆ æ–‡ä»¶ç»Ÿè®¡:"
          echo "   GitHubæ–‡ä»¶æ•°: $(find github_repo -type f | wc -l)"
          echo "   Giteeæ–‡ä»¶æ•°: $(find gitee_repo -type f | wc -l)"
          
          echo ""
          echo "â° å®Œæˆæ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          echo "========================================"

      # 12. é”™è¯¯å¤„ç†
      - name: ğŸš¨ é”™è¯¯å¤„ç†
        if: failure()
        run: |
          echo "========================================"
          echo "âŒ åŒæ­¥å¤±è´¥"
          echo "========================================"
          echo ""
          echo "å¸¸è§é—®é¢˜æ’æŸ¥:"
          echo ""
          echo "1. ğŸ”‘ Tokené—®é¢˜:"
          echo "   - GitHub Token: ${{ env.GITHUB_TOKEN_SECRET }}"
          echo "     è®¿é—®: https://github.com/settings/tokens"
          echo "     éœ€è¦æƒé™: repo"
          echo ""
          echo "   - Gitee Token: ${{ env.GITEE_TOKEN_SECRET }}"
          echo "     è®¿é—®: https://gitee.com/profile/personal_access_tokens"
          echo "     éœ€è¦æƒé™: projects"
          echo ""
          echo "2. ğŸ“¦ ä»“åº“æƒé™:"
          echo "   - GitHubä»“åº“: ${{ env.GITHUB_USER }}/${{ env.GITHUB_REPO }}"
          echo "   - Giteeä»“åº“: ${{ env.GITEE_USER }}/${{ env.GITEE_REPO }}"
          echo ""
          echo "3. ğŸŒ ç½‘ç»œé—®é¢˜:"
          echo "   - æ£€æŸ¥GitHub Actionsç½‘ç»œè¿æ¥"
          echo "   - ç¡®ä¿æ²¡æœ‰IPé™åˆ¶"
          echo ""
          echo "4. ğŸ“ è·¯å¾„é—®é¢˜:"
          echo "   - æºæ–‡ä»¶å¤¹: ${{ github.event.inputs.source_folder || 'æ ¹ç›®å½•' }}"
          echo "   - ç›®æ ‡æ–‡ä»¶å¤¹: ${{ github.event.inputs.target_folder || 'æ ¹ç›®å½•' }}"
          echo ""
          echo "ğŸ’¡ æç¤º: å¯ä»¥å°è¯•å…ˆæ‰‹åŠ¨åœ¨Giteeåˆ›å»ºä»“åº“"
          echo "========================================"
