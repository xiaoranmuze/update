name: ğŸ¤– Live Source Auto Backup

on:
  schedule:
    - cron: '0 17 * * *'  # åŒ—äº¬æ—¶é—´å‡Œæ™¨1ç‚¹
  workflow_dispatch:
    inputs:
      cleanup_days:
        description: 'æ¸…ç†å¤©æ•°ï¼ˆé»˜è®¤7ï¼‰'
        required: false
        default: '7'
        
jobs:
  backup-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout with write permissions
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Setup Beijing timezone
      run: |
        sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
        echo "ğŸ• åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        
    - name: Create live source backup
      id: backup
      run: |
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        mkdir -p history
        
        # æ£€æŸ¥æ˜¯å¦æœ‰txtæ–‡ä»¶éœ€è¦å¤‡ä»½
        if [ -d "output" ] && [ "$(find output -name '*.txt' -type f 2>/dev/null | wc -l)" -gt 0 ]; then
          BEIJING_TIME=$(TZ='Asia/Shanghai' date +"%Y%m%d_%H%M%S")
          ZIP_NAME="livesource_$BEIJING_TIME.zip"
          
          echo "ğŸ“¦ å¼€å§‹åˆ›å»ºå¤‡ä»½: $ZIP_NAME"
          
          # ç»Ÿè®¡æ–‡ä»¶ä¿¡æ¯
          TXT_COUNT=$(find output -name '*.txt' -type f | wc -l)
          echo "ğŸ“„ æºæ–‡ä»¶æ•°é‡: $TXT_COUNT"
          
          # åˆ›å»ºå¤‡ä»½
          cd output
          zip -qr "../history/$ZIP_NAME" *.txt
          cd ..
          
          # è·å–å¤‡ä»½ä¿¡æ¯
          BACKUP_SIZE=$(du -h "history/$ZIP_NAME" | cut -f1)
          BACKUP_FILES=$(unzip -l "history/$ZIP_NAME" 2>/dev/null | grep -c "\.txt$" || echo "N/A")
          
          echo "âœ… å¤‡ä»½å®Œæˆ"
          echo "ğŸ“Š å¤‡ä»½ä¿¡æ¯:"
          echo "  - æ–‡ä»¶: $ZIP_NAME"
          echo "  - å¤§å°: $BACKUP_SIZE"
          echo "  - åŒ…å«æ–‡ä»¶æ•°: $BACKUP_FILES"
          
          # è¾“å‡ºå¤‡ä»½ä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT
          echo "backup_time=$BEIJING_TIME" >> $GITHUB_OUTPUT
          echo "file_count=$BACKUP_FILES" >> $GITHUB_OUTPUT
          echo "has_backup=true" >> $GITHUB_OUTPUT
        else
          echo "â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°éœ€è¦å¤‡ä»½çš„txtæ–‡ä»¶"
          echo "has_backup=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Cleanup old backups
      id: cleanup
      run: |
        # ç¡®å®šæ¸…ç†å¤©æ•°
        CLEANUP_DAYS="${{ github.event.inputs.cleanup_days || '7' }}"
        echo "ğŸ§¹ å¼€å§‹æ¸…ç†${CLEANUP_DAYS}å¤©å‰çš„æ—§å¤‡ä»½..."
        
        # éªŒè¯è¾“å…¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
        if ! [[ "$CLEANUP_DAYS" =~ ^[0-9]+$ ]] || [ "$CLEANUP_DAYS" -le 0 ]; then
          echo "âš ï¸ è­¦å‘Š: æ¸…ç†å¤©æ•° '$CLEANUP_DAYS' æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤å€¼ 7"
          CLEANUP_DAYS="7"
        fi
        
        # æ ¹æ®æ–‡ä»¶åä¸­çš„æ—¶é—´è¿›è¡Œæ¸…ç†
        if [ -d "history" ]; then
          # è·å–å½“å‰æ—¶é—´ï¼ˆUnixæ—¶é—´æˆ³ï¼‰
          CURRENT_TS=$(date +%s)
          # è®¡ç®—æ¸…ç†æˆªæ­¢æ—¶é—´ï¼ˆç§’æ•°ï¼‰
          CUTOFF_TS=$((CURRENT_TS - CLEANUP_DAYS * 24 * 60 * 60))
          
          echo "å½“å‰æ—¶é—´æˆ³: $CURRENT_TS"
          echo "æ¸…ç†æˆªæ­¢æ—¶é—´æˆ³: $CUTOFF_TSï¼ˆ${CLEANUP_DAYS}å¤©å‰ï¼‰"
          
          # åˆå§‹åŒ–è®¡æ•°å™¨
          REMOVED_COUNT=0
          
          # éå†æ‰€æœ‰å¤‡ä»½æ–‡ä»¶
          for zipfile in history/livesource_*.zip; do
            if [ -f "$zipfile" ]; then
              # ä»æ–‡ä»¶åä¸­æå–æ—¶é—´
              FILENAME=$(basename "$zipfile")
              # æå–æ—¥æœŸéƒ¨åˆ†ï¼šlivesource_20251214_091849.zip -> 20251214
              FILE_DATE=$(echo "$FILENAME" | grep -oE '[0-9]{8}' | head -1)
              
              if [ -n "$FILE_DATE" ]; then
                # å°†æ—¥æœŸè½¬æ¢ä¸ºUnixæ—¶é—´æˆ³ï¼ˆYYYYMMDD -> YYYY-MM-DDï¼‰
                YEAR=${FILE_DATE:0:4}
                MONTH=${FILE_DATE:4:2}
                DAY=${FILE_DATE:6:2}
                FILE_TS=$(date -d "${YEAR}-${MONTH}-${DAY}" +%s 2>/dev/null || echo "0")
                
                if [ "$FILE_TS" != "0" ] && [ "$FILE_TS" -lt "$CUTOFF_TS" ]; then
                  echo "åˆ é™¤: $FILENAME (æ—¥æœŸ: ${YEAR}-${MONTH}-${DAY}, æ—¶é—´æˆ³: $FILE_TS)"
                  rm -f "$zipfile"
                  REMOVED_COUNT=$((REMOVED_COUNT + 1))
                else
                  echo "ä¿ç•™: $FILENAME (æ—¥æœŸ: ${YEAR}-${MONTH}-${DAY})"
                fi
              fi
            fi
          done
          
          if [ $REMOVED_COUNT -gt 0 ]; then
            echo "âœ… æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº† $REMOVED_COUNT ä¸ªæ–‡ä»¶"
          else
            echo "âœ… æ²¡æœ‰éœ€è¦æ¸…ç†çš„æ—§æ–‡ä»¶"
          fi
          
          echo "removed_count=$REMOVED_COUNT" >> $GITHUB_OUTPUT
        else
          echo "â„¹ï¸ historyç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸…ç†"
          echo "removed_count=0" >> $GITHUB_OUTPUT
        fi
        
        echo "cleanup_days=$CLEANUP_DAYS" >> $GITHUB_OUTPUT
        
    - name: Auto Commit and Push
      id: commitpush
      run: |
        # é…ç½®gitç”¨æˆ·
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        git status --porcelain > /tmp/git_changes.txt
        if [ ! -s /tmp/git_changes.txt ]; then
          echo "ğŸ“­ æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "ğŸ”„ æ£€æµ‹åˆ°å˜æ›´:"
        cat /tmp/git_changes.txt
        
        # æ·»åŠ å˜æ›´
        git add .
        
        # è·å–åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        
        # æ ¼å¼åŒ–æäº¤æ—¶é—´ï¼ˆç”¨äºæäº¤ä¿¡æ¯ï¼‰
        COMMIT_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        
        # ç”Ÿæˆæäº¤ä¿¡æ¯ï¼ˆä½¿ç”¨ ğŸ¤– è¡¨æƒ…å’Œçº¯æ—¶é—´æˆ³ï¼‰
        COMMIT_MSG="ğŸ¤– $COMMIT_TIME"
        
        echo "ğŸ“ æäº¤ä¿¡æ¯: $COMMIT_MSG"
        
        # æäº¤å˜æ›´
        git commit -m "$COMMIT_MSG"
        
        # æ¨é€åˆ°è¿œç¨‹ä»“åº“
        echo "ğŸš€ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
        git push
        
        echo "âœ… æäº¤å¹¶æ¨é€æˆåŠŸ"
        echo "has_changes=true" >> $GITHUB_OUTPUT
        echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
        
    - name: Send summary notification
      if: steps.commitpush.outputs.has_changes == 'true'
      run: |
        echo "ğŸ“¢ ä»»åŠ¡æ‰§è¡Œæ‘˜è¦"
        echo "========================"
        
        # æ˜¾ç¤ºæ—¶é—´ä¿¡æ¯ - ä¿®æ­£æ—¶åŒºæ˜¾ç¤º
        UTC_TIME=$(date -u '+%Y-%m-%d %H:%M:%S')  # ä½¿ç”¨ -u å‚æ•°è·å–UTCæ—¶é—´
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        echo "ğŸŒ UTCæ—¶é—´: $UTC_TIME"
        echo "ğŸ‡¨ğŸ‡³ åŒ—äº¬æ—¶é—´: $BEIJING_TIME"
        echo "ğŸ¤– æäº¤ä¿¡æ¯: ${{ steps.commitpush.outputs.commit_message }}"
        
        echo ""
        echo "ğŸ“Š å¤‡ä»½çŠ¶æ€:"
        if [ "${{ steps.backup.outputs.has_backup }}" = "true" ]; then
          echo "âœ… åˆ›å»ºäº†æ–°å¤‡ä»½: ${{ steps.backup.outputs.zip_name }}"
          echo "   æ–‡ä»¶æ•°: ${{ steps.backup.outputs.file_count }}"
        else
          echo "â„¹ï¸ æœ¬æ¬¡æœªåˆ›å»ºæ–°å¤‡ä»½"
        fi
        
        echo ""
        echo "ğŸ—‘ï¸ æ¸…ç†çŠ¶æ€:"
        echo "   æ¸…ç†è®¾ç½®: ä¿ç•™æœ€è¿‘ ${{ steps.cleanup.outputs.cleanup_days || '7' }} å¤©çš„å¤‡ä»½"
        if [ "${{ steps.cleanup.outputs.removed_count }}" != "0" ]; then
          echo "   æ¸…ç†æ–‡ä»¶: ${{ steps.cleanup.outputs.removed_count }} ä¸ª"
        else
          echo "   æ¸…ç†æ–‡ä»¶: æ— "
        fi
        
        echo ""
        echo "ğŸ“ å½“å‰å¤‡ä»½æ–‡ä»¶åˆ—è¡¨:"
        if [ -d "history" ]; then
          ls -lh history/livesource_*.zip 2>/dev/null | head -5 || echo "æš‚æ— å¤‡ä»½æ–‡ä»¶"
          TOTAL=$(ls history/livesource_*.zip 2>/dev/null | wc -l)
          echo "æ€»è®¡: $TOTAL ä¸ªå¤‡ä»½æ–‡ä»¶"
        else
          echo "historyç›®å½•ä¸å­˜åœ¨"
        fi
        
        echo ""
        echo "ğŸ“„ Outputç›®å½•txtæ–‡ä»¶å†…å®¹:"
        if [ -d "output" ]; then
          TXT_FILES=$(find output -name "*.txt" -type f 2>/dev/null | wc -l)
          if [ $TXT_FILES -gt 0 ]; then
            echo "æ‰¾åˆ° $TXT_FILES ä¸ªtxtæ–‡ä»¶:"
            echo "----------------------------------------"
            for txtfile in output/*.txt; do
              if [ -f "$txtfile" ]; then
                FILENAME=$(basename "$txtfile")
                FILESIZE=$(du -h "$txtfile" | cut -f1)
                LINECOUNT=$(wc -l < "$txtfile" 2>/dev/null || echo "N/A")
                echo "ğŸ“„ $FILENAME (å¤§å°: $FILESIZE, è¡Œæ•°: $LINECOUNT)"
                echo "----------------------------------------"
              fi
            done
          else
            echo "outputç›®å½•ä¸­æ²¡æœ‰txtæ–‡ä»¶"
          fi
        else
          echo "outputç›®å½•ä¸å­˜åœ¨"
        fi
        
        echo ""
        echo "â° ä¸‹æ¬¡è¿è¡Œ: æ˜å¤© 01:00 (åŒ—äº¬æ—¶é—´)"
