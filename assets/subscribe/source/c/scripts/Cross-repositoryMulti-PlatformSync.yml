name: Cross Repository Multi-Platform Sync ğŸ”„

on:
  workflow_dispatch:
    inputs:
      # ==================== æºä»“åº“é…ç½® ====================
      source_repo:
        description: 'æºä»“åº“ï¼ˆæ ¼å¼ï¼šç”¨æˆ·å/ä»“åº“å@åˆ†æ”¯ï¼‰'
        required: true
        default: 'xiaoran67/update@main'
        type: string
      
      source_folder:
        description: 'æºæ–‡ä»¶å¤¹è·¯å¾„ï¼ˆå¤šçº§ç›®å½•ç”¨/åˆ†éš”ï¼Œç•™ç©º=æ ¹ç›®å½•ï¼‰'
        required: false
        default: 'output'
        type: string
      
      source_token:
        description: 'æºä»“åº“Tokençš„Secretåç§°'
        required: true
        default: 'XIAORAN67_GITHUB_TOKEN'
        type: string

      # ==================== ç›®æ ‡ä»“åº“é…ç½® ====================
      target_repo:
        description: 'ç›®æ ‡ä»“åº“ï¼ˆæ ¼å¼ï¼šç”¨æˆ·å/ä»“åº“å@åˆ†æ”¯ï¼‰'
        required: true
        default: 'xiaoran37/update@main'
        type: string
      
      target_folder:
        description: 'ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆå¤šçº§ç›®å½•ç”¨/åˆ†éš”ï¼Œç•™ç©º=æ ¹ç›®å½•ï¼‰'
        required: false
        default: 'output'
        type: string
      
      target_token:
        description: 'ç›®æ ‡ä»“åº“Tokençš„Secretåç§°'
        required: true
        default: 'XIAORAN37_GITHUB_TOKEN'
        type: string
      
      target_platform:
        description: 'ç›®æ ‡ä»“åº“å¹³å°'
        required: true
        type: choice
        options:
          - 'github'
          - 'gitee'
          - 'gitcode'
        default: 'github'

      # ==================== åŒæ­¥ç­–ç•¥ ====================
      sync_mode:
        description: 'æ›´æ–°æ¨¡å¼'
        required: true
        type: choice
        options:
          - 'å¢é‡'
          - 'è¦†ç›–'
        default: 'å¢é‡'
      
      commit_message:
        description: 'æäº¤ä¿¡æ¯ï¼ˆå¯ç”¨å˜é‡ï¼š{time} {date} {source} {target}ï¼‰'
        required: false
        default: 'ğŸ”„ {date} {time}'
        type: string

jobs:
  folder-sync:
    runs-on: ubuntu-latest
    steps:
      # 1. è§£æå’ŒéªŒè¯é…ç½®
      - name: ğŸ§© è§£æé…ç½®ä¿¡æ¯
        id: parse_config
        run: |
          echo "=== é…ç½®è§£æ ==="
          
          # è§£ææºä»“åº“
          if echo "${{ inputs.source_repo }}" | grep -qE '^[a-zA-Z0-9-]+/[a-zA-Z0-9-]+@[a-zA-Z0-9-]+$'; then
            IFS='/@' read -r source_user source_repo source_branch <<< "${{ inputs.source_repo }}"
            echo "æºç”¨æˆ·: $source_user"
            echo "æºä»“åº“: $source_repo" 
            echo "æºåˆ†æ”¯: $source_branch"
            echo "source_user=$source_user" >> $GITHUB_ENV
            echo "source_repo=$source_repo" >> $GITHUB_ENV
            echo "source_branch=$source_branch" >> $GITHUB_ENV
          else
            echo "âŒ æºä»“åº“æ ¼å¼é”™è¯¯ï¼Œåº”ä¸ºï¼šç”¨æˆ·å/ä»“åº“å@åˆ†æ”¯"
            exit 1
          fi
          
          # è§£æç›®æ ‡ä»“åº“
          if echo "${{ inputs.target_repo }}" | grep -qE '^[a-zA-Z0-9-]+/[a-zA-Z0-9-]+@[a-zA-Z0-9-]+$'; then
            IFS='/@' read -r target_user target_repo target_branch <<< "${{ inputs.target_repo }}"
            echo "ç›®æ ‡ç”¨æˆ·: $target_user"
            echo "ç›®æ ‡ä»“åº“: $target_repo"
            echo "ç›®æ ‡åˆ†æ”¯: $target_branch"
            echo "target_user=$target_user" >> $GITHUB_ENV
            echo "target_repo=$target_repo" >> $GITHUB_ENV
            echo "target_branch=$target_branch" >> $GITHUB_ENV
          else
            echo "âŒ ç›®æ ‡ä»“åº“æ ¼å¼é”™è¯¯ï¼Œåº”ä¸ºï¼šç”¨æˆ·å/ä»“åº“å@åˆ†æ”¯"
            exit 1
          fi
          
          # è®¾ç½®å…¶ä»–å˜é‡
          echo "source_folder=${{ inputs.source_folder }}" >> $GITHUB_ENV
          echo "target_folder=${{ inputs.target_folder }}" >> $GITHUB_ENV
          echo "sync_mode=${{ inputs.sync_mode }}" >> $GITHUB_ENV
          echo "target_platform=${{ inputs.target_platform }}" >> $GITHUB_ENV

      # 2. æ ¡éªŒToken
      - name: ğŸ”‘ æ ¡éªŒTokenæœ‰æ•ˆæ€§
        run: |
          echo "=== Tokenæ ¡éªŒ ==="
          if [ -z "${{ secrets[inputs.source_token] }}" ]; then
            echo "âŒ æºä»“åº“Tokenä¸å­˜åœ¨: ${{ inputs.source_token }}"
            exit 1
          fi
          if [ -z "${{ secrets[inputs.target_token] }}" ]; then
            echo "âŒ ç›®æ ‡ä»“åº“Tokenä¸å­˜åœ¨: ${{ inputs.target_token }}"
            exit 1
          fi
          echo "âœ… Tokenæ ¡éªŒé€šè¿‡"

      # 3. å®‰è£…å¿…è¦å·¥å…·
      - name: ğŸ› ï¸ å®‰è£…åŒæ­¥å·¥å…·
        run: |
          echo "=== å®‰è£…å·¥å…· ==="
          sudo apt-get update
          sudo apt-get install -y rsync tree
          echo "âœ… rsyncå®‰è£…å®Œæˆ"

      # 4. æ£€å‡ºæºä»“åº“
      - name: ğŸ“¥ æ£€å‡ºæºä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ env.source_user }}/${{ env.source_repo }}
          ref: ${{ env.source_branch }}
          path: source_repo
          token: ${{ secrets[inputs.source_token] }}
          fetch-depth: 1

      # 5. å‡†å¤‡ç›®æ ‡ä»“åº“
      - name: ğŸ“¦ å‡†å¤‡ç›®æ ‡ä»“åº“
        run: |
          echo "=== å‡†å¤‡ç›®æ ‡ä»“åº“ ==="
          TARGET_TOKEN="${{ secrets[inputs.target_token] }}"
          
          # æ ¹æ®ç›®æ ‡å¹³å°æ„å»ºURL
          case "${{ env.target_platform }}" in
            "github")
              TARGET_URL="https://${TARGET_TOKEN}@github.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              ;;
            "gitee")
              TARGET_URL="https://${{ env.target_user }}:${TARGET_TOKEN}@gitee.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              ;;
            "gitcode")
              TARGET_URL="https://${{ env.target_user }}:${TARGET_TOKEN}@gitcode.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              ;;
          esac
          
          echo "ç›®æ ‡ä»“åº“URL: $TARGET_URL"
          
          # å…‹éš†ç›®æ ‡ä»“åº“
          git clone --branch ${{ env.target_branch }} --depth=1 "$TARGET_URL" target_repo 2>/dev/null || {
            echo "âš ï¸ ç›®æ ‡ä»“åº“ä¸å­˜åœ¨æˆ–å…‹éš†å¤±è´¥ï¼Œå°è¯•åˆå§‹åŒ–..."
            mkdir -p target_repo
            cd target_repo
            git init
            git remote add origin "$TARGET_URL"
            git checkout -b ${{ env.target_branch }}
            cd ..
          }
          
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          mkdir -p "target_repo/${{ env.target_folder }}"
          echo "âœ… ç›®æ ‡ä»“åº“å‡†å¤‡å®Œæˆ"

      # 6. æ‰§è¡ŒåŒæ­¥ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
      - name: ğŸ”„ æ‰§è¡Œæ–‡ä»¶åŒæ­¥
        id: sync_files
        run: |
          echo "=== æ‰§è¡Œæ–‡ä»¶åŒæ­¥ ==="
          echo "åŒæ­¥æ¨¡å¼: ${{ env.sync_mode }}"
          
          # æ„å»ºæºè·¯å¾„å’Œç›®æ ‡è·¯å¾„
          SOURCE_PATH="source_repo"
          TARGET_PATH="target_repo"
          
          [ -n "${{ env.source_folder }}" ] && SOURCE_PATH="source_repo/${{ env.source_folder }}"
          [ -n "${{ env.target_folder }}" ] && TARGET_PATH="target_repo/${{ env.target_folder }}"
          
          echo "æºè·¯å¾„: $SOURCE_PATH"
          echo "ç›®æ ‡è·¯å¾„: $TARGET_PATH"
          
          # æ£€æŸ¥æºè·¯å¾„æ˜¯å¦å­˜åœ¨
          if [ ! -d "$SOURCE_PATH" ] && [ ! -f "$SOURCE_PATH" ]; then
            echo "âŒ æºè·¯å¾„ä¸å­˜åœ¨: $SOURCE_PATH"
            exit 1
          fi
          
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          mkdir -p "$(dirname "$TARGET_PATH")"
          
          # æ ¹æ®åŒæ­¥æ¨¡å¼æ‰§è¡Œä¸åŒçš„rsyncå‘½ä»¤
          if [ "${{ env.sync_mode }}" = "å¢é‡" ]; then
            echo "ğŸ”„ æ‰§è¡Œå¢é‡åŒæ­¥ï¼ˆåˆ«äººæœ‰æˆ‘æœ‰â†’æ›´æ–°ï¼Œåˆ«äººæ— æˆ‘æœ‰â†’å¤åˆ¶ï¼Œåˆ«äººæœ‰æˆ‘æ— â†’ä¸ç®¡ï¼‰"
            # -u: åªæ›´æ–°ï¼ˆç›®æ ‡ä¸­æ›´æ–°çš„æ–‡ä»¶ä¸è¦†ç›–ï¼‰
            # --ignore-existing: å¿½ç•¥ç›®æ ‡ä¸­å·²å­˜åœ¨çš„æ–‡ä»¶
            # å®é™…ä¸Šæ ‡å‡†çš„å¢é‡æ˜¯ï¼šæºæœ‰ç›®æ ‡æ— â†’å¤åˆ¶ï¼Œæºæ–°ç›®æ ‡æ—§â†’æ›´æ–°ï¼Œæºæ— ç›®æ ‡æœ‰â†’ä¿ç•™
            rsync -rltvh --progress "$SOURCE_PATH"/ "$TARGET_PATH"/
          else
            echo "ğŸ”„ æ‰§è¡Œè¦†ç›–åŒæ­¥ï¼ˆä½¿ç›®æ ‡ä¸æºå®Œå…¨ä¸€è‡´ï¼‰"
            # --delete: åˆ é™¤ç›®æ ‡ä¸­å­˜åœ¨ä½†æºä¸­ä¸å­˜åœ¨çš„æ–‡ä»¶
            rsync -rltvh --progress --delete "$SOURCE_PATH"/ "$TARGET_PATH"/
          fi
          
          echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆ"
          
          # æ˜¾ç¤ºåŒæ­¥ç»“æœ
          echo "=== åŒæ­¥ç»“æœ ==="
          echo "æºç›®å½•å†…å®¹:"
          ls -la "$SOURCE_PATH" | head -10
          echo "..."
          echo "ç›®æ ‡ç›®å½•å†…å®¹:"
          ls -la "$TARGET_PATH" | head -10
          echo "..."

      # 7. æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–éœ€è¦æäº¤
      - name: ğŸ” æ£€æŸ¥æ–‡ä»¶å˜åŒ–
        id: check_changes
        run: |
          echo "=== æ£€æŸ¥æ–‡ä»¶å˜åŒ– ==="
          cd target_repo
          
          # æ£€æŸ¥gitçŠ¶æ€
          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ”„ æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œéœ€è¦æäº¤"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºå…·ä½“å˜åŒ–
            echo "=== å…·ä½“å˜åŒ– ==="
            git status
            git diff --stat
          else
            echo "âœ… æ— æ–‡ä»¶å˜åŒ–ï¼Œæ— éœ€æäº¤"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

      # 8. æäº¤å’Œæ¨é€å˜åŒ–
      - name: ğŸ“¤ æäº¤å¹¶æ¨é€æ›´æ”¹
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          echo "=== æäº¤æ›´æ”¹ ==="
          cd target_repo
          
          # é…ç½®Gitç”¨æˆ·
          git config user.name "Auto Sync Bot"
          git config user.email "sync-bot@noreply.github.com"
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          CURRENT_TIME=$(TZ='Asia/Shanghai' date +'%H:%M:%S')
          CURRENT_DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
          COMMIT_MSG="${{ inputs.commit_message }}"
          
          # æ›¿æ¢æ¨¡æ¿å˜é‡
          COMMIT_MSG="${COMMIT_MSG//\{time\}/$CURRENT_TIME}"
          COMMIT_MSG="${COMMIT_MSG//\{date\}/$CURRENT_DATE}"
          COMMIT_MSG="${COMMIT_MSG//\{source\}/${{ env.source_user }}/${{ env.source_repo }}:${{ env.source_branch }}}"
          COMMIT_MSG="${COMMIT_MSG//\{target\}/${{ env.target_user }}/${{ env.target_repo }}:${{ env.target_branch }}}"
          
          echo "æäº¤ä¿¡æ¯: $COMMIT_MSG"
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶å¹¶æäº¤
          git add -A
          git commit -m "$COMMIT_MSG"
          
          # æ¨é€åˆ°ç›®æ ‡ä»“åº“
          echo "=== æ¨é€åˆ°ç›®æ ‡ä»“åº“ ==="
          TARGET_TOKEN="${{ secrets[inputs.target_token] }}"
          
          case "${{ env.target_platform }}" in
            "github")
              PUSH_URL="https://${TARGET_TOKEN}@github.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              ;;
            "gitee")
              PUSH_URL="https://${{ env.target_user }}:${TARGET_TOKEN}@gitee.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              ;;
            "gitcode")
              PUSH_URL="https://${{ env.target_user }}:${TARGET_TOKEN}@gitcode.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              ;;
          esac
          
          # æ ¹æ®åŒæ­¥æ¨¡å¼å†³å®šæ˜¯å¦å¼ºåˆ¶æ¨é€
          if [ "${{ env.sync_mode }}" = "è¦†ç›–" ]; then
            echo "ğŸ”„ è¦†ç›–æ¨¡å¼ï¼Œä½¿ç”¨å¼ºåˆ¶æ¨é€"
            git push "$PUSH_URL" HEAD:${{ env.target_branch }} --force
          else
            echo "ğŸ”„ å¢é‡æ¨¡å¼ï¼Œä½¿ç”¨æ™®é€šæ¨é€"
            git push "$PUSH_URL" HEAD:${{ env.target_branch }}
          fi
          
          echo "âœ… æ¨é€å®Œæˆ"

      # 9. ç”ŸæˆåŒæ­¥æŠ¥å‘Š
      - name: ğŸ“Š ç”ŸæˆåŒæ­¥æŠ¥å‘Š
        run: |
          echo "=== ğŸ”„ åŒæ­¥æŠ¥å‘Š ==="
          echo ""
          echo "âœ… åŒæ­¥ä»»åŠ¡å®Œæˆ"
          echo ""
          echo "ğŸ“Œ åŒæ­¥æ¨¡å¼: ${{ env.sync_mode }}"
          echo ""
          echo "ğŸ“¥ æºä»“åº“:"
          echo "   å¹³å°: GitHub"
          echo "   ä»“åº“: ${{ env.source_user }}/${{ env.source_repo }}"
          echo "   åˆ†æ”¯: ${{ env.source_branch }}"
          echo "   ç›®å½•: ${{ env.source_folder || 'æ ¹ç›®å½•' }}"
          echo ""
          echo "ğŸ“¤ ç›®æ ‡ä»“åº“:"
          echo "   å¹³å°: ${{ env.target_platform }}"
          echo "   ä»“åº“: ${{ env.target_user }}/${{ env.target_repo }}"
          echo "   åˆ†æ”¯: ${{ env.target_branch }}"
          echo "   ç›®å½•: ${{ env.target_folder || 'æ ¹ç›®å½•' }}"
          echo ""
          
          if [ "${{ steps.check_changes.outputs.changes_detected }}" = "true" ]; then
            echo "ğŸ”„ åŒæ­¥ç»“æœ: æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–å¹¶å·²æäº¤æ¨é€"
          else
            echo "â„¹ï¸ åŒæ­¥ç»“æœ: æ— æ–‡ä»¶å˜åŒ–ï¼Œæ— éœ€æäº¤"
          fi
          
          echo ""
          echo "â° å®Œæˆæ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          echo "=========================================="

      # 10. é”™è¯¯å¤„ç†
      - name: ğŸš¨ é”™è¯¯å¤„ç†
        if: failure()
        run: |
          echo "=== âŒ åŒæ­¥å¤±è´¥ ==="
          echo "é”™è¯¯è¯¦æƒ…è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—"
          echo ""
          echo "å¸¸è§é—®é¢˜æ’æŸ¥:"
          echo "1. æ£€æŸ¥Tokenæ˜¯å¦æœ‰å¯¹åº”ä»“åº“çš„æƒé™"
          echo "2. æ£€æŸ¥ä»“åº“åœ°å€å’Œåˆ†æ”¯æ˜¯å¦å­˜åœ¨"
          echo "3. æ£€æŸ¥æ–‡ä»¶å¤¹è·¯å¾„æ˜¯å¦æ­£ç¡®"
          echo "4. æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸"
          exit 1
